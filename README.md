# Morizo AI - Python AIエージェント

Smart Pantry MVPのAIエージェント（LLM処理 + 音声認識）

## 🚨 緊急課題

### 在庫数量の不一致問題 ✅ **解決完了**
**優先度: 最高** ✅ **2025年9月24日解決**

**問題**: AI報告とDB実際の在庫数量に重大な不一致が発生
- AI報告: 牛乳6本
- DB実際: 牛乳9本（15件の在庫データから6個の牛乳タスクが生成）

**影響**: 
- ユーザーに誤った在庫情報を提供
- 在庫管理の信頼性に致命的な影響
- 削除・更新操作の安全性に問題

**原因分析**:
- LLMの応答が途中で切れる（max_tokens制限）
- JSON解析エラーによるフォールバック処理
- ActionPlannerのプロンプトが長すぎて応答が不完全
- **根本原因**: LLMの単純な足し算が苦手

**実施した対策**:
1. ✅ **ActionPlannerのmax_tokens増加**: 1000→1500に増加
2. ✅ **プロンプト最適化**: 在庫要約の簡潔化とプロンプト全体の簡素化
3. ✅ **LLM集計指示の強化**: 正確な集計ルールと具体例を追加
4. ✅ **フォールバック処理の改善**: 不適切なタスク生成の検出と処理

**解決結果**:
- ✅ **牛乳**: 9本（正確）
- ✅ **鶏もも肉**: 3パック（正確）
- ✅ **もやし**: 3袋（正確）
- ✅ **パン**: 3袋（正確）

**解決日**: 2025年9月24日
**ステータス**: ✅ **完全解決**

## 🎉 解決済み課題

### MCPツール拡張による一括操作の実現 ✅ **解決完了**
**優先度: 高** ✅ **2025年9月24日解決**

**問題**: 一括操作要求での複雑なタスク分解とエラー発生
- 「牛乳9本全部削除」→ 9個の個別削除タスク → MCP tool error
- 「パンは冷凍したから、賞味期限をクリアしておいて」→ 複雑なタスク分解

**影響**: 
- ユーザーの自然な要求が複雑な処理に変換される
- 多数のタスクによるエラー発生
- ユーザー体験の悪化

**解決策**: MCPツール拡張アプローチ
1. ✅ **inventory_delete_by_name**: 名前指定での一括削除
2. ✅ **inventory_update_by_name**: 名前指定での一括更新
3. ✅ **設計思想の転換**: ReActループの複雑化 → MCPツール拡張

**解決結果**:
- ✅ **「牛乳9本全部削除」**: 1つの一括削除タスクで完了
- ✅ **「パンは冷凍したから、賞味期限をクリアしておいて」**: 1つの一括更新タスクで完了
- ✅ **拡張性の実現**: 新しい要求パターンにMCPツール追加で対応可能

**設計思想の勝利**:
- **従来**: 1つの引出（複雑なReActループ）で全てを処理
- **今回**: 複数の引出（専用MCPツール）で適材適所

**解決日**: 2025年9月24日
**ステータス**: ✅ **完全解決**

## プロジェクト構成

- **Morizo-ai** - Python AIエージェント（このリポジトリ）
- **Morizo-web** - Next.js Webアプリ（別リポジトリ）
- **Morizo-mobile** - Expo モバイルアプリ（別リポジトリ）

## 📁 フォルダ構成（リファクタリング後）

```
Morizo AI/
├── main.py                           # メインアプリケーション（145行）
├── session_manager.py                 # セッション管理
├── true_react_agent.py               # 真のReActエージェント
├── action_planner.py                  # 行動計画立案
├── task_manager.py                    # タスク管理
├── db_mcp_server_stdio.py            # MCPサーバー
├── config/                           # 設定管理
│   ├── __init__.py
│   ├── logging_config.py             # ログ設定・ローテーション
│   └── cors_config.py                 # CORS設定
├── auth/                             # 認証・セキュリティ
│   ├── __init__.py
│   └── authentication.py             # Supabase認証
├── agents/                           # エージェント・MCP
│   ├── __init__.py
│   └── mcp_client.py                  # MCPクライアント
├── models/                           # データモデル
│   ├── __init__.py
│   └── requests.py                    # Pydanticモデル
├── utils/                            # ユーティリティ
│   ├── __init__.py
│   ├── session_utils.py               # セッション管理
│   └── llm_utils.py                   # LLM処理
├── handlers/                         # ハンドラー
│   ├── __init__.py
│   ├── chat_handler.py                # チャット処理
│   └── session_handler.py             # セッション管理
├── tests/                            # テスト
│   └── test_true_react_agent_short.py # 真のReActエージェントテスト
├── docs/                             # ドキュメント
├── backups/                          # バックアップファイル
└── requirements.txt                  # 依存関係
```

## 機能

### AIエージェント
- OpenAI GPT-4による自然言語処理
- 音声コマンドの意図解析
- 食材在庫管理の自動化
- レシピ提案の生成
- **真のAIエージェント**: 複雑な要求のタスク分解とReActループ実行
- **動的MCPエージェント**: リアルタイムツール選択と実行
- **挨拶パターンの適切な処理**: 2025/9/24完了
- **不適切なタスク生成の検出とフォールバック**: 2025/9/24完了
- **プロンプト最適化とエラーハンドリング改善**: 2025/9/24完了

### ✅ 解決済み課題
- **在庫数量不一致問題の解決**: ✅ **2025年9月24日解決**
- **LLM応答の完全性確保**: ✅ **max_tokens増加とプロンプト最適化で解決**
- **在庫集計ロジックの見直し**: ✅ **LLM集計指示の強化で解決**

### セッション管理システム
- **メモリ内セッション**: ユーザー別のセッション管理
- **操作履歴**: 最大10件の操作履歴保持
- **在庫状態管理**: ID情報を含む在庫一覧の保持
- **自動タイムアウト**: 期限切れセッションの自動クリア

### 真のAIエージェントシステム
- **ActionPlanner**: 複雑な要求のタスク分解と依存関係管理
- **TaskManager**: タスクの状態管理と実行順序の最適化
- **TrueReactAgent**: 観察→思考→決定→行動の完全なループ
- **統合テスト**: 複雑な要求のテストとエラー処理の検証

### FIFO原則による在庫管理
- **個別在庫法**: 各アイテムを個別に管理
- **最古→最新**: デフォルトで最古アイテムを優先
- **ユーザー指定**: 「最新」指定時は最新アイテムを選択
- **ID取得**: セッションから適切なIDを自動取得

### データベース連携
- Supabase PostgreSQLとの連携
- 在庫データの読み書き
- ユーザー認証情報の取得
- **MCP統合**: マイクロエージェント通信プロトコル

## クイックスタート

### 1. 環境準備
```bash
cd /app/Morizo-ai
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### 2. 環境変数設定
```bash
cp .env.example .env
# .envファイルに必要な設定を記入
```

### 3. サーバー起動
```bash
python main.py
# または
uvicorn main:app --reload --port 8000
```

### 4. 動作確認
```bash
curl http://localhost:8000/health
```

## ドキュメント

- **[詳細セットアップ](docs/SETUP.md)** - セットアップ手順（MCP依存関係問題の解決手順含む）
- **[API仕様](docs/API.md)** - エンドポイント詳細
- **[認証機能](docs/AUTHENTICATION.md)** - 認証システム
- **[アーキテクチャ](docs/ARCHITECTURE.md)** - システム設計
- **[開発ロードマップ](docs/ROADMAP.md)** - 開発計画・ToDo
- **[MCP作成フロー](docs/MAKINGMCP.md)** - MCPサーバー実装手順
- **[自前ReActループ実装フロー](docs/MAKINGREACT.md)** - 動的MCPエージェント実装手順

## 技術スタック

- **フレームワーク**: FastAPI 0.117.1
- **言語**: Python 3.11+
- **AI/ML**: OpenAI API 1.108.1 (GPT-4, Whisper)
- **データベース**: Supabase PostgreSQL 2.19.0
- **認証**: Supabase Auth
- **FastMCP**: Micro-Agent Communication Protocol 2.12.3
- **HTTP**: httpx 0.28.1

## 🎉 最新の成果

**2025年9月23日** - リファクタリング完了！統一されたReActエージェントが完成！

### ✅ リファクタリング成果
- **71%のコード削減**: main.py 504行 → 145行
- **完全な責任分離**: 15のモジュールに分割
- **統一されたReActエージェント**: 単純・複雑問わず同じフロー
- **真のAIエージェント化**: ActionPlanner + TaskManager + TrueReactAgent
- **保守性の大幅向上**: 各モジュールが独立して動作

### ✅ 実装完了
- **FastMCP 2.12.3**でMCPサーバー構築
- **5つのCRUDツール**が正常動作
- **Supabase認証**と**データベース操作**が統合
- **stdio接続**で軽量動作
- **完全動的MCPエージェント**実現
- **自然言語での在庫管理**が実現
- **ハードコーディングの完全排除**

### 🚀 次のステップ
- **Phase 4.4**: 確認プロセス（操作前検証、確認ダイアログ）
- **Phase 4.5**: ロールバック機能（操作履歴、Undo/Redo機能）
- **レシピ提案機能**の追加

## 関連リポジトリ

- **[Morizo-web](../Morizo-web)**: Next.js Webアプリケーション
- **[Morizo-mobile](../Morizo-mobile)**: Expo モバイルアプリ

## 開発状況

- ✅ **Phase 1**: 基本機能（完了）
- ✅ **Phase 2**: MCP化（完了）
- ✅ **Phase 3**: 動的AIエージェント化（完了）
- ✅ **Phase 4.1**: 基本コンテキスト管理（完了）
- ✅ **Phase 4.2**: インテリジェント判断（完了）
- ✅ **Phase 4.3**: 真のAIエージェント化（完了）
- ✅ **リファクタリング**: 統一されたReActエージェント（完了）
- 🚀 **Phase 4.4**: 確認プロセス（計画中）
- 🚀 **Phase 4.5**: ロールバック機能（計画中）

詳細は[開発ロードマップ](docs/ROADMAP.md)と[自前ReActループ実装フロー](docs/MAKINGREACT.md)をご確認ください。

## ライセンス

このプロジェクトは**プロプライエタリライセンス**の下で提供されています。

- **商用利用**: 別途ライセンス契約が必要
- **改変・再配布**: 禁止
- **個人利用**: 許可（非商用のみ）
- **教育・研究目的**: 許可（適切な帰属表示が必要）

詳細は[LICENSE](LICENSE)ファイルをご確認ください。

## AIエージェント協働

このプロジェクトでは、AIエージェントとの協働ルールを定めています。
詳細は[AGENTS.md](AGENTS.md)をご確認ください。