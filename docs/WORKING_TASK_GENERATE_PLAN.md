# Morizo AI - レシピ提案機能 実装タスク

## 📋 概要

**タスク名**: 献立提案機能のMCP実装  
**開始日**: 2025年1月27日  
**ステータス**: 設計完了 → 実装開始  
**担当**: AIエージェント協働チーム  
**バージョン**: 1.0

## 🎯 目標

ミニマリスト対応の献立提案機能を実現するため、以下の課題を解決する：

- **献立構成**: 主菜・副菜・汁物の3品構成
- **食材重複回避**: 各料理で同じ食材を使用しない
- **過去履歴管理**: 過去1-2週間のレシピを除外
- **食材効率**: 限られた食材の最大活用
- **実用性**: 実際の家庭の献立構成

## 🧠 設計思想

### **RAGの役割（壁打ちで明確化）**
- **❌ 誤解**: RAGで直接レシピを検索する
- **✅ 正解**: RAGでLLMのレシピ提案を**補佐**する

### **処理フロー**
1. **LLM**: 在庫食材から献立タイトルを生成
2. **RAG**: 生成されたタイトルに類似するレシピを検索
3. **LLM**: RAGの結果を参考に、より具体的なレシピを提案
4. **Web検索**: 最終的なレシピ詳細を取得

### **RAGの補佐機能**
- **レシピタイトルの精度向上**: 既存の美味しいレシピを参考
- **食材の組み合わせ提案**: 実際に使われている組み合わせを学習
- **文化的適切性**: 日本の食文化に合った提案

### **疎結合設計の実現**
- **モジュール独立性**: 各MCPが独立して動作
- **責任分離**: recipe_mcp（献立生成）、db_mcp（データ操作）
- **再利用性**: 他のMCPからも利用可能
- **テスト容易性**: 単体テストが可能

## 🏗️ 設計概要

### **献立提案システム**
```
在庫食材 → 献立構成（主菜・副菜・汁物） → 過去履歴チェック → レシピ検索 → 献立提案
```

### **MCPツール構成**
```
1. generate_menu_plan: 献立構成生成
2. check_cooking_history: 過去履歴チェック
3. search_recipe_from_rag: RAG検索によるレシピ検索
```

## 📅 実装の優先順位

### **Phase 1: ベクトルDB構築（事前処理）** ✅ **完了**
- [x] **レシピデータ前処理** - `me2you/recipe_data.jsonl`の解析・正規化 ✅ **完了**
  - [x] レシピ情報の抽出（タイトル、食材、分類） ✅ **完了**
  - [x] 主菜・副菜・汁物の分類 ✅ **完了**
  - [x] 食材の正規化・標準化 ✅ **完了**
- [x] **ベクトル化** - LangChain + ChromaによるベクトルDB構築 ✅ **完了**
  - [x] OpenAI Embeddings APIの設定 ✅ **完了**
  - [x] テキストの結合（タイトル + 食材 + 分類） ✅ **完了**
  - [x] ベクトル化の実行 ✅ **完了**
- [x] **永続化** - ローカルディスクへの保存 ✅ **完了**
  - [x] ChromaDBの永続化設定 ✅ **完了**
  - [x] ベクトルDBの保存確認 ✅ **完了**
  - [x] インデックスの最適化 ✅ **完了**

#### **Phase 1完了報告（2025年9月25日）**
- **処理件数**: 6,233件のレシピデータ
- **コスト**: 13セント（約20円）
- **出力先**: `/app/Morizo-ai/recipe_vector_db/`
- **前処理**: 複雑なJSON → シンプルな1行テキスト
- **ベクトル化**: OpenAI Embeddings → ChromaDB
- **永続化**: ローカルディスクに保存完了

### **Phase 2: 基本献立機能** ✅ **完了**
- [x] **DB MCP拡張** - recipesテーブルのCRUD操作 ✅ **完了**
  - [x] recipes_add - レシピ履歴の追加 ✅ **完了**
  - [x] recipes_list - レシピ履歴一覧取得（created_at昇順） ✅ **完了**
  - [x] recipes_update_latest - 最新レシピの更新（メンテナンス用） ✅ **完了**
  - [x] recipes_delete_latest - 最新レシピの削除（メンテナンス用） ✅ **完了**
- [x] **`generate_menu_plan_with_history`** - 在庫食材から献立構成生成（過去履歴を考慮） ✅ **完了**
  - [x] LLM呼び出しの実装 ✅ **完了**
  - [x] 食材配分アルゴリズム ✅ **完了**
  - [x] 献立タイプ（和食・洋食・中華）の対応 ✅ **完了**
  - [x] 過去履歴のチェックと除外 ✅ **完了**
- [x] **食材配分アルゴリズム** - 重複回避のロジック ✅ **完了**
  - [x] 主菜：メイン食材（肉・魚・卵など） ✅ **完了**
  - [x] 副菜：野菜・きのこなど ✅ **完了**
  - [x] 汁物：軽い食材・調味料 ✅ **完了**

#### **Phase 2完了報告（2025年9月25日）**
- **DB MCP拡張**: recipesテーブルのCRUD操作を追加
- **利用可能ツール**: recipes_add, recipes_list, recipes_update_latest, recipes_delete_latest
- **テストスクリプト**: `/app/Morizo-ai/tests/test_recipes_crud.py` 作成
- **設計の進化**: 壁打ち結果を`RECIPE_MCP_DESIGN.md`に反映
- **Recipe MCP Server**: `recipe_mcp_server_stdio.py` 作成
- **献立生成機能**: `generate_menu_plan_with_history` 実装完了
- **テストスクリプト**: `/app/Morizo-ai/tests/test_recipe_mcp.py` 作成
- **AIネイティブアプローチ**: 複雑な食材分類ロジックをLLMに委譲
- **LLM統合**: OpenAI GPT-4o-miniによる献立タイトル生成
- **疎結合設計**: モジュール独立性を実現（285行→222行、22%削減）
- **過去履歴管理**: 除外レシピをパラメータで受け取る設計
- **次のステップ**: Phase 3（RAG補佐によるレシピ検索機能）の実装準備完了

### **Phase 3: RAG補佐システム基盤構築** 🔄 **進行中**
- [x] **レシピMCP統合** - 主処理への組み込み ✅ **2025年9月26日完了**
  - [x] MCPクライアントの拡張（複数MCPサーバー対応）
  - [x] ActionPlannerの更新（レシピMCPツール認識）
  - [x] TrueReactAgentの更新（レシピMCPツール実行）
  - [x] 利用可能ツール: 16個（DB MCP: 15個 + Recipe MCP: 1個）
- [x] **プロンプト最適化** - トークン使用量の大幅削減 ✅ **2025年9月26日完了**
  - [x] 階層的フィルタリング（16個 → 4個のツール選択）
  - [x] シンプル応答パターン検出（挨拶・雑談の早期判定）
  - [x] ツール説明文短縮（30文字以内に制限）
  - [x] 1972トークン → 747トークン（62%削減）
- [ ] **RAG検索機能** - ベクトルDB検索の実装
  - [ ] 事前構築済みベクトルDBとの連携
  - [ ] 類似レシピ検索機能
  - [ ] 検索結果のランキング・フィルタリング
- [ ] **LLM補佐機能** - RAG検索結果の活用
  - [ ] 食材の組み合わせパターン学習
  - [ ] 文化的適切性の向上（日本の食文化に合った提案）
  - [ ] レシピタイトル精度向上の実装
- [ ] **`search_recipe_from_rag`** - RAG検索によるレシピ検索
  - [ ] 料理タイプ別の検索（主菜・副菜・汁物）
  - [ ] 食材制約の考慮
  - [ ] 使用禁止食材の除外
- [ ] **Web検索統合** - Google Search API連携
  - [ ] Web検索（Google Search API）でレシピ詳細取得
  - [ ] RAG検索結果とWeb検索結果の統合
  - [ ] 結果の統合・ランキング

### **Phase 4: RAG補佐統合献立提案** ⏳ **未着手**
- [ ] **RAG補佐献立生成** - Phase 3のRAG機能を統合
  - [ ] Phase 3で構築したRAG検索機能の統合
  - [ ] LLM + RAG の協調による献立生成
  - [ ] 文化的適切性の向上（RAG補佐による）
  - [ ] 食材重複回避の強化（RAG補佐による）
- [ ] **完全な献立提案** - 履歴除外済みの献立
  - [ ] 3品構成の完全な提案
  - [ ] 食材使用状況の表示
  - [ ] 残り食材の明示
- [ ] **代替案生成** - 複数の献立パターン
  - [ ] 複数の献立候補
  - [ ] ユーザー選択機能
  - [ ] 好みに応じた調整
- [ ] **買い物提案** - 不足食材の提案
  - [ ] 不足食材の特定
  - [ ] 買い物リストの生成
  - [ ] 優先度の設定

## 🔧 技術的準備

### **依存関係の追加** ✅ **完了**
- [x] **LangChain** - ベクトル化とRAG検索 ✅ **完了**
- [x] **Chroma** - ベクトルデータベース ✅ **完了**
- [x] **OpenAI Embeddings** - テキストのベクトル化 ✅ **完了**
- [x] **Google Search API** - Web検索機能 ✅ **完了**
- [x] **requirements.txt** の更新 ✅ **完了**

### **テスト実装** ✅ **部分完了**
- [x] **Phase 1テスト** - ベクトルDB構築 ✅ **完了**
  - [x] `build_vector_db.py` のテスト ✅ **完了**
  - [x] `test_recipe_vector_db.py` のテスト ✅ **完了**
- [x] **Phase 2テスト** - 基本献立機能 ✅ **完了**
  - [x] `test_recipes_crud.py` のテスト ✅ **完了**
  - [x] `test_recipe_mcp.py` のテスト ✅ **完了**
- [ ] **Phase 3テスト** - RAG補佐システム
  - [ ] RAG検索機能のテスト
  - [ ] LLM補佐機能のテスト
  - [ ] Web検索統合のテスト
- [ ] **Phase 4テスト** - 統合提案機能
  - [ ] RAG補佐献立生成のテスト
  - [ ] 完全な献立提案のテスト
  - [ ] 代替案生成のテスト

### **メインReActループとの統合** ⏳ **未着手**
- [ ] **ActionPlanner** の更新
  - [ ] 献立提案用のタスク分解
  - [ ] 新しいツールの認識
- [ ] **TaskManager** の更新
  - [ ] 献立提案のタスク実行
  - [ ] 依存関係の管理
- [ ] **TrueReactAgent** の更新
  - [ ] 献立提案のReActループ
  - [ ] エラーハンドリング

## 🎯 成功基準

### **Phase 1完了基準**
- [ ] ベクトルDBが正常に構築される
- [ ] 6,234件のレシピがベクトル化される
- [ ] 検索機能が正常に動作する

### **Phase 2完了基準**
- [ ] 献立構成が正常に生成される
- [ ] 過去履歴のチェックが動作する
- [ ] 食材の重複回避が機能する

### **Phase 3完了基準**
- [ ] 献立用レシピ検索が動作する
- [ ] Web検索とRAG検索が統合される
- [ ] 食材制約が適切に機能する

### **Phase 4完了基準**
- [ ] 完全な献立提案が生成される
- [ ] 代替案の生成が機能する
- [ ] 買い物提案が動作する

## 🚀 期待される効果

- **ミニマリスト対応**: 限られた食材の最大活用
- **献立の多様性**: 過去履歴管理による飽きない提案
- **実用性**: 実際の家庭の献立構成
- **食材効率**: 重複回避による無駄の削減
- **時間効率**: 調理時間の最適化

## 📝 メモ・注意事項

- 既存のMCPサーバーとの互換性を維持
- パフォーマンスへの影響を最小限に抑制
- ユーザー体験を最優先に考慮
- 段階的な実装でリスクを最小化
- 法的リスク（Web検索）の軽減策を実装

## 🔗 関連ドキュメント

- [レシピ提案機能設計](RECIPE_MCP_DESIGN.md) - 詳細な設計仕様
- [データベース設計](DDL.md) - recipesテーブルの仕様
- [開発ロードマップ](ROADMAP.md) - 全体の開発計画

---

**最終更新**: 2025年1月27日  
**バージョン**: 1.0  
**作成者**: AIエージェント協働チーム
