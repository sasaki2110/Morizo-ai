# Morizo AI - 開発ロードマップ


## Phase 1: 基本機能 ✅

### 完了済み
- [x] FastAPIサーバー構築
- [x] OpenAI API連携（GPT-4o-mini対応）
- [x] Supabase認証システム
- [x] 基本チャット機能
- [x] 依存関係管理（httpx互換性解決）
- [x] CORS設定
- [x] エラーハンドリング
- [x] API動作確認

## Phase 2: MCP化 ✅ **完了！**

### Supabase CRUD MCP ✅ **2025/9/22完了**
- [x] Supabase CRUD MCPサーバー作成 ✅ **2025/9/21完了**
- [x] 在庫管理の基本CRUD操作 ✅ **5つのツール実装完了**
- [x] ユーザー別データアクセス制御 ✅ **JWT認証実装完了**
- [x] **アノテーション方式のMCPサーバー** ✅ **2025/9/22完了**
- [x] **stdio接続のMCPサーバー** ✅ **2025/9/22完了**
- [x] **自動起動機能** ✅ **2025/9/22完了**
- [ ] リアルタイム更新機能
- [ ] mcp.json設定

### Recipe RAG MCP
- [ ] レシピデータのRAG化
- [ ] ベクトル検索機能
- [ ] レシピ提案システム
- [ ] 履歴管理

### Web Search MCP
- [ ] Web検索機能
- [ ] レシピ情報の取得
- [ ] データクリーニング

### Voice Processing MCP
- [ ] 音声認識機能
- [ ] 音声コマンド解析
- [ ] 音声応答生成

## Phase 3: 動的AIエージェント化 ✅ **完了**

### MCP統合完了 ✅ **2025/9/22完了**
- [x] **main.pyへの統合** ✅ **2025/9/22完了**
- [x] **認証システムの統合** ✅ **JWT認証完了**
- [x] **自然言語での在庫管理** ✅ **動作確認完了**
- [x] **デバッグログの統合** ✅ **詳細ログ実装完了**

### 🚀 依存関係管理と並列実行システム ✅ **2025/9/27完了**
- [x] **Phase A: 依存関係解決** ✅ **2025/9/27完了**
  - [x] ActionPlanner: タスクIDと依存関係の生成機能
  - [x] TrueReactAgent: 依存関係を考慮した実行順序決定
  - [x] 基本的な依存関係管理の動作確認
- [x] **Phase B: データフロー** ✅ **2025/9/27完了**
  - [x] データ注入機能: 前のタスクの結果を次のタスクに動的に注入
  - [x] 型安全な変換: 文字列から配列への適切な変換
  - [x] inventory_list → generate_menu_plan_with_history のデータフロー動作確認
- [x] **Phase C: 並列実行** ✅ **2025/9/27完了**
  - [x] 並列実行機能: asyncio.gatherを使用した並列実行
  - [x] 依存関係グループ化: 同じ依存関係を持つタスクをグループ化
  - [x] エラーハンドリング: 並列実行失敗時の個別実行フォールバック
  - [x] inventory_add タスク2つの並列実行動作確認
- [x] **真のAIエージェント完成** ✅ **2025/9/27完了**
  - [x] 複雑なタスクを効率的に処理
  - [x] 依存関係を理解し、データを流し、並列実行する
  - [x] 統一ReActエージェントとしての完全動作

## Phase 5: リファクタリング ✅ **2025/9/23完了**

### 統一されたReActエージェント ✅ **完了**
- [x] **なんちゃってReAct削除** ✅ **2025/9/23完了**
- [x] **真のReActエージェント統一** ✅ **単純・複雑問わず同じフロー**
- [x] **ActionPlanner統合** ✅ **自然にタスク数を決定**
- [x] **TaskManager統合** ✅ **タスク管理とReActループ**
- [x] **挨拶パターンの適切な処理** ✅ **2025/9/24完了**
- [x] **不適切なタスク生成の検出とフォールバック** ✅ **2025/9/24完了**
- [x] **プロンプト最適化とエラーハンドリング改善** ✅ **2025/9/24完了**

### 解決済み課題
- [x] **MCPツール拡張による一括操作の実現** ✅ **2025年9月24日解決**
- [x] **在庫数量不一致問題の解決** ✅ **2025年9月24日解決**
- [x] **LLM応答の完全性確保** ✅ **max_tokens増加とプロンプト最適化で解決**
- [x] **在庫集計ロジックの見直し** ✅ **LLM集計指示の強化で解決**

### モジュラー設計 ✅ **完了**
- [x] **71%のコード削減** ✅ **main.py 504行 → 145行**
- [x] **完全な責任分離** ✅ **15のモジュールに分割**
- [x] **設定管理分離** ✅ **config/ディレクトリ**
- [x] **認証分離** ✅ **auth/ディレクトリ**
- [x] **エージェント分離** ✅ **agents/ディレクトリ**
- [x] **モデル分離** ✅ **models/ディレクトリ**
- [x] **ユーティリティ分離** ✅ **utils/ディレクトリ**
- [x] **ハンドラー分離** ✅ **handlers/ディレクトリ**

### 保守性向上 ✅ **完了**
- [x] **インポート構造最適化** ✅ **循環参照なし**
- [x] **エラーハンドリング強化** ✅ **詳細なログ出力**
- [x] **バックアップ管理** ✅ **適切なバックアップ保存**
- [x] **テスト互換性** ✅ **既存テストが正常動作**

## Phase 4: 高度なAIエージェント化 🔄 **進行中**

### Phase 4.1: 基本コンテキスト管理 ✅ **2025/9/23完了**
- [x] **セッション管理システム** ✅ **メモリ内セッション実装完了**
- [x] **操作履歴** ✅ **最大10件の履歴保持完了**
- [x] **現在の在庫状態** ✅ **ID情報を含む状態管理完了**

### Phase 4.2: インテリジェント判断 ✅ **2025/9/23完了**
- [x] **自然言語解析** ✅ **LLMによるコンテキスト活用完了**
- [x] **FIFO原則** ✅ **個別在庫法による適切なID取得完了**
- [x] **曖昧性検出** ✅ **ユーザー指定の正確な理解完了**
- [x] **コンテキスト分析** ✅ **在庫状況と操作履歴の活用完了**

### Phase 4.3: True AI Agent ✅ **2025/9/26完了**
- [x] **FIFO/最新削除機能** ✅ **4つの新MCPツール実装完了**
- [x] **動的ツール説明取得** ✅ **FastMCP統合完了**
- [x] **疎結合アーキテクチャ** ✅ **ハードコーディング排除完了**
- [x] **トークン最適化** ✅ **60%削減達成**
- [x] **統合テスト** ✅ **全テストケース成功**
- [x] **RAG検索機能** ✅ **ベクトルDB検索による類似レシピ検索完了**
- [x] **Perplexity API統合** ✅ **Web検索機能による人間のレシピ取得完了**
- [x] **テストスイート完成** ✅ **MCPサーバー個別テスト + 統合テスト完了**

### Phase 4.4: 操作履歴とロールバック 🔄 **未着手**
- [ ] **ロールバック機能**
- [ ] **Undo/Redo機能**
- [ ] **状態復元機能**

### 動的MCPエージェント ✅ **2025/9/22完了**
- [x] **動的ツール選択** ✅ **LLMによる適切なツール選択**
- [x] **動的ツール実行** ✅ **ハードコーディングの完全排除**
- [x] **動的結果整形** ✅ **LLMによる結果の整形**
- [x] **統一されたインターフェース** ✅ **/chatエンドポイントのみ**
- [x] **真の拡張性** ✅ **新しいツールの自動認識**

## Phase 4: 高度なAIエージェント化 🚀 **計画中**

### 設計課題の解決
- [ ] **MCPサーバーの再設計** - CRUDを統合した在庫更新ツール
- [ ] **LLMの思考プロセス強化** - CRUD操作の本質的な判断
- [ ] **高度なパラメータ抽出** - 文脈を理解したパラメータ抽出
- [ ] **レシピ提案機能** - 食材マッチングとレシピ検索

### AI Agent Loop 🚀 **計画中**

#### Perception（認識）
- [ ] 音声入力の認識
- [ ] テキスト意図の解析
- [ ] コンテキスト理解

#### Cognition（思考）
- [ ] 意図の判断
- [ ] 適切なツールの選択
- [ ] 行動計画の立案

#### Action（行動）
- [ ] Supabase CRUD操作
- [ ] レシピ生成・提案
- [ ] Web検索実行
- [ ] レスポンス生成

## Phase 4: 高度な機能 🌟

### 状態管理
- [ ] セッション管理
- [ ] 会話履歴の保持
- [ ] ユーザー設定の管理

### 自動化
- [ ] ツール選択の自動化
- [ ] エラー回復機能
- [ ] 学習機能

### 拡張性
- [ ] プラグインシステム
- [ ] カスタムツール追加
- [ ] 外部API連携

## 技術的ToDo

### MCP実装
- [x] FastMCPでHTTP通信実装 ✅ **2025/9/21完了**
- [x] **FastMCPでstdio通信実装** ✅ **2025/9/22完了**
- [x] **自動起動機能実装** ✅ **2025/9/22完了**
- [ ] mcp.jsonでの設定管理
- [x] エラーハンドリング ✅ **CallToolResult処理完了**
- [ ] ログ管理

### データベース設計
- [x] 在庫管理テーブル設計 ✅ **DDL.mdで完了**
- [ ] レシピマスターデータ設計
- [ ] ユーザー設定テーブル設計
- [ ] インデックス最適化

### セキュリティ
- [x] Row Level Security (RLS) 設定 ✅ **DDL.mdで完了**
- [x] API権限管理 ✅ **JWT認証実装完了**
- [ ] データ暗号化

## 現在の優先度

1. **Supabase CRUD MCP** - ✅ **完全完了！**
2. **stdio接続への移行** - ✅ **完了！**
3. **main.pyへの統合** - ✅ **完了！**
4. **動的MCPエージェント** - ✅ **完了！**
5. **高度なAIエージェント化** - 🚀 **計画中**
6. **レシピ提案機能** - 食材マッチングとレシピ検索

## 完了基準

### Phase 2完了基準 ✅ **達成！**
- Supabase CRUD MCPが正常動作 ✅ **完了**
- stdio接続でMCPサーバー管理 ✅ **完了**
- 基本チャット機能がMCP経由で動作 ✅ **完了**

### Phase 3完了基準 ✅ **達成！**
- 動的MCPエージェントが正常動作 ✅ **完了**
- 動的ツール選択が実装 ✅ **完了**
- 自然言語での在庫管理が可能 ✅ **完了**
- ハードコーディングの完全排除 ✅ **完了**
- Perplexity API統合によるWeb検索機能 ✅ **完了**

### Phase 4完了基準
- 高度なAIエージェント化が実装
- 文脈を理解したCRUD操作が可能
- レシピ提案機能が動作
- エラーハンドリングが適切

---

## 🎉 Phase 3完了記念！

**2025年9月22日** - Phase 3: 動的AIエージェント化が完全完了！

### ✅ 達成した成果

#### **完全動的MCPエージェントの実現**
1. **動的ツール選択** - LLMがMCPサーバーから取得したツールリストから適切なツールを選択
2. **動的ツール実行** - ハードコーディングを完全に削除し、任意のツールを動的に実行
3. **動的結果整形** - LLMがすべてのツール結果を適切に整形
4. **統一されたインターフェース** - すべての操作が`/chat`エンドポイント経由で実行

#### **技術的達成**
- ✅ **FastMCP 2.12.3**: 最新版で安定動作
- ✅ **アノテーション方式**: `@mcp.tool()` デコレータ
- ✅ **stdio接続**: プロセス間通信で軽量動作
- ✅ **ReActパターン**: 観察→思考→決定→行動のループ
- ✅ **自然言語処理**: 「牛乳を2本、冷蔵庫に追加して」が正常動作
- ✅ **自動起動**: テスト時の手動起動が不要
- ✅ **完全なCRUD操作**: 5つのツールが全て動作
- ✅ **Supabase認証**: JWT トークン認証が正常動作
- ✅ **セキュリティ**: トークンの安全な取り扱い

#### **推奨実装**
**stdio版（`supabase_mcp_server_stdio.py`）を最優先推奨**
- 軽量、自動起動、ローカル通信、公式準拠

### 🚀 次のフェーズ

**Phase 4: 高度なAIエージェント化** が開始されました！

#### **2025年9月22日の成果**
- ✅ **動的MCPエージェント**: 完全動的なツール選択と実行
- ✅ **ハードコーディング排除**: すべての操作が動的に実行
- ✅ **自然言語在庫管理**: 「牛乳を2本、冷蔵庫に追加して」が正常動作
- ✅ **統一されたインターフェース**: `/chat`エンドポイントのみで全操作

#### **次のステップ**
- 🚀 **高度なAIエージェント化**: 文脈を理解したCRUD操作
- 🚀 **レシピ提案**: 食材マッチングとレシピ検索機能
- 🚀 **設計課題の解決**: MCPサーバーの再設計とLLM思考プロセス強化

---

## 📝 **2025年9月23日 - 嫁からの突っ込みメモ**

### **開発状況の確認**
- **AIエージェント側**: Phase 4.1-4.3完了、リファクタリング完了
- **WEB・MOBILE版**: 開発を進める予定
- **次のフェーズ**: Phase 4.4（確認プロセス）、Phase 4.5（ロールバック機能）

### **嫁からの指摘事項**
- 開発の進捗状況を適切に把握する必要がある
- 各コンポーネント（AI、WEB、MOBILE）の進捗を明確に管理
- 全体のバランスを考慮した開発計画の見直し

### **今後の方針**
- WEB・MOBILE版の開発に集中
- AIエージェント側は基盤が完成済み
- 必要に応じてAIエージェント側の機能追加

---

## 🍳 **嫁からの実用的な要望（2025年9月23日）**

### **現在の在庫管理の問題点**
- **購入日（登録日）**: あるけど、実際には重要度が低い
- **賞味期限**: あるけど、これは開封前の期限
- **開封日**: **これが最も重要！** でも誰も覚えていない

### **嫁の要望**
1. **開封日の管理**: 開封した日を記録・管理する機能
2. **開封後期限**: 開封後1週間以内などの期限設定
3. **アラートの柔軟性**: 
   - 開封後期限切れアラートを出さない設定
   - 「もったいないから使う」という判断を尊重
   - アラートチェックの無効化機能
4. **実用的な管理**: 実際の生活に即した在庫管理

### **実装すべき機能**
- [ ] **開封日記録**: アイテムの開封日を記録する機能
- [ ] **開封後期限設定**: 開封後の消費期限を設定
- [ ] **アラート設定の柔軟性**: ユーザーがアラートを無効化可能
- [ ] **実生活に即した管理**: 購入日より開封日を重視したUI

### **嫁のコメント**
> 「わがままな嫁ですね(笑)」  
> でも、実際の生活では開封日が一番重要！

---

## 🚀 **商用運用レベルへの拡張計画**

### **Phase 6: 商用化準備（Q1-Q2 2025）** 🔄 **計画中**

#### **6.1 スケーラビリティ強化**
- [ ] **マイクロサービス化**: 各機能を独立したサービスに分割
- [ ] **API Gateway**: 統一されたAPIエンドポイント管理
- [ ] **負荷分散**: 複数インスタンスでの負荷分散
- [ ] **自動スケーリング**: 需要に応じた自動リソース調整
- [ ] **キャッシュ戦略**: Redis/Memcachedによる高速化

#### **6.2 高可用性・災害復旧**
- [ ] **マルチリージョン**: 複数地域での冗長化
- [ ] **データベース複製**: マスター・スレーブ構成
- [ ] **バックアップ戦略**: 自動バックアップとリストア
- [ ] **監視システム**: 24/7のシステム監視
- [ ] **アラート機能**: 障害時の即座な通知

#### **6.3 セキュリティ強化**
- [ ] **暗号化**: データの暗号化（保存時・転送時）
- [ ] **認証強化**: 多要素認証、OAuth2.0
- [ ] **API セキュリティ**: レート制限、API キー管理
- [ ] **監査ログ**: 全操作の詳細ログ記録
- [ ] **セキュリティ監査**: 定期的なセキュリティチェック

### **Phase 7: 高度なAI機能（Q2-Q3 2025）** 🔄 **計画中**

#### **7.1 マルチモーダルAI**
- [ ] **音声認識強化**: 雑音環境での高精度認識
- [ ] **画像認識**: 食材の自動識別・賞味期限OCR
- [ ] **自然言語理解**: より複雑な要求の理解
- [ ] **感情分析**: ユーザーの感情に応じた応答
- [ ] **多言語対応**: 日本語・英語・その他言語

#### **7.2 予測・推奨システム**
- [ ] **在庫予測**: 機械学習による在庫需要予測
- [ ] **レシピ推奨**: 在庫と好みに基づくレシピ提案
- [ ] **購入推奨**: 不足予測に基づく買い物リスト
- [ ] **価格最適化**: 食材価格の動的調整
- [ ] **健康管理**: 栄養バランスの分析・提案

#### **7.3 学習・適応機能**
- [ ] **ユーザー学習**: 個人の行動パターン学習
- [ ] **パーソナライゼーション**: 個人化された体験
- [ ] **継続学習**: 使用データからの継続的改善
- [ ] **A/Bテスト**: 機能の効果測定
- [ ] **フィードバックループ**: ユーザーフィードバックの活用

### **Phase 8: エンタープライズ機能（Q3-Q4 2025）** 🔄 **計画中**

#### **8.1 マルチテナント対応**
- [ ] **組織管理**: 企業・団体向けの管理機能
- [ ] **ユーザー管理**: 階層的なユーザー権限管理
- [ ] **データ分離**: テナント別データ分離
- [ ] **カスタマイズ**: 組織別のカスタマイズ機能
- [ ] **SSO連携**: 企業のSSOシステム連携

#### **8.2 高度な分析機能**
- [ ] **BI連携**: ビジネスインテリジェンス連携
- [ ] **レポート生成**: 自動レポート生成
- [ ] **ダッシュボード**: リアルタイム分析ダッシュボード
- [ ] **データエクスポート**: 各種形式でのデータ出力
- [ ] **予測分析**: 高度な予測分析機能

#### **8.3 統合・連携機能**
- [ ] **ERP連携**: 企業のERPシステム連携
- [ ] **POS連携**: レジシステム連携
- [ ] **在庫管理システム**: 既存システムとの連携
- [ ] **会計システム**: 会計ソフトとの連携
- [ ] **API エコシステム**: サードパーティ連携

### **Phase 9: グローバル展開（Q4 2025-2026）** 🔄 **計画中**

#### **9.1 国際化・ローカライゼーション**
- [ ] **多言語対応**: 20言語以上の対応
- [ ] **地域別カスタマイズ**: 各国の文化・習慣に適応
- [ ] **通貨・単位**: 地域別の通貨・単位対応
- [ ] **法的対応**: 各国の法規制対応
- [ ] **現地パートナー**: 現地企業との提携

#### **9.2 グローバルインフラ**
- [ ] **CDN展開**: 全世界での高速配信
- [ ] **データセンター**: 主要地域でのデータセンター
- [ ] **コンプライアンス**: GDPR、CCPA等の対応
- [ ] **現地サポート**: 24/7の多言語サポート
- [ ] **現地開発**: 現地開発チームの設立

## 💼 **商用化戦略**

### **収益モデル**
- **SaaS**: 月額・年額サブスクリプション
- **エンタープライズ**: 企業向けカスタムソリューション
- **API**: サードパーティ向けAPI提供
- **データ**: 匿名化データの販売
- **コンサルティング**: AI導入支援サービス

### **市場戦略**
- **B2C**: 個人ユーザー向けスマートホーム
- **B2B**: レストラン・食品業界向け
- **B2B2C**: 小売業者経由での提供
- **パートナーシップ**: 家電メーカーとの提携
- **オープンプラットフォーム**: エコシステム構築

### **競合優位性**
- **AI技術**: 独自のAIアルゴリズム
- **データ**: 豊富な食材・レシピデータ
- **ユーザー体験**: 直感的な音声操作
- **統合性**: 既存システムとの高い連携性
- **カスタマイズ**: 柔軟なカスタマイズ機能

## 📊 **成功指標（商用レベル）**

### **技術指標**
- **可用性**: 99.9%以上の稼働率
- **レスポンス時間**: API応答時間 < 100ms
- **スループット**: 10,000 RPS以上の処理能力
- **エラー率**: 0.01%以下のエラー率
- **セキュリティ**: ゼロセキュリティインシデント

### **ビジネス指標**
- **ユーザー数**: 100万ユーザー突破
- **収益**: 年間10億円の売上
- **市場シェア**: スマートホーム分野で10%のシェア
- **顧客満足度**: NPS スコア 70以上
- **リテンション**: 月次リテンション率 90%以上

### **運用指標**
- **コスト効率**: ユーザーあたりの運用コスト削減
- **スケーラビリティ**: 10倍の負荷増加に対応
- **開発効率**: 機能開発サイクルの50%短縮
- **品質**: バグ発生率の90%削減
- **イノベーション**: 月次新機能リリース

## 🎯 **マイルストーン（商用レベル）**

### **2025年 Q1**
- Phase 6.1: スケーラビリティ強化
- 商用化準備開始
- パイロット顧客獲得

### **2025年 Q2**
- Phase 6.2-6.3: 高可用性・セキュリティ強化
- Phase 7.1: マルチモーダルAI
- ベータ版リリース

### **2025年 Q3**
- Phase 7.2-7.3: 予測・学習機能
- Phase 8.1: マルチテナント対応
- 正式版リリース

### **2025年 Q4**
- Phase 8.2-8.3: エンタープライズ機能
- Phase 9.1: 国際化開始
- グローバル展開開始

### **2026年**
- Phase 9.2: グローバルインフラ
- 全世界展開完了
- IPO準備

---

**最終目標**: 世界最大級のスマートパントリーAIエージェントプラットフォーム
