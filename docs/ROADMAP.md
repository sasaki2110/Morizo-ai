# Morizo AI - 開発ロードマップ

## Phase 1: 基本機能 ✅

### 完了済み
- [x] FastAPIサーバー構築
- [x] OpenAI API連携（GPT-4o-mini対応）
- [x] Supabase認証システム
- [x] 基本チャット機能
- [x] 依存関係管理（httpx互換性解決）
- [x] CORS設定
- [x] エラーハンドリング
- [x] API動作確認

## Phase 2: MCP化 ✅ **完了！**

### Supabase CRUD MCP ✅ **2025/9/22完了**
- [x] Supabase CRUD MCPサーバー作成 ✅ **2025/9/21完了**
- [x] 在庫管理の基本CRUD操作 ✅ **5つのツール実装完了**
- [x] ユーザー別データアクセス制御 ✅ **JWT認証実装完了**
- [x] **アノテーション方式のMCPサーバー** ✅ **2025/9/22完了**
- [x] **stdio接続のMCPサーバー** ✅ **2025/9/22完了**
- [x] **自動起動機能** ✅ **2025/9/22完了**
- [ ] リアルタイム更新機能
- [ ] mcp.json設定

### Recipe RAG MCP
- [ ] レシピデータのRAG化
- [ ] ベクトル検索機能
- [ ] レシピ提案システム
- [ ] 履歴管理

### Web Search MCP
- [ ] Web検索機能
- [ ] レシピ情報の取得
- [ ] データクリーニング

### Voice Processing MCP
- [ ] 音声認識機能
- [ ] 音声コマンド解析
- [ ] 音声応答生成

## Phase 3: 動的AIエージェント化 ✅ **完了**

### MCP統合完了 ✅ **2025/9/22完了**
- [x] **main.pyへの統合** ✅ **2025/9/22完了**
- [x] **認証システムの統合** ✅ **JWT認証完了**
- [x] **自然言語での在庫管理** ✅ **動作確認完了**
- [x] **デバッグログの統合** ✅ **詳細ログ実装完了**

## Phase 4: 高度なAIエージェント化 🔄 **進行中**

### Phase 4.1: 基本コンテキスト管理 ✅ **2025/9/23完了**
- [x] **セッション管理システム** ✅ **メモリ内セッション実装完了**
- [x] **操作履歴** ✅ **最大10件の履歴保持完了**
- [x] **現在の在庫状態** ✅ **ID情報を含む状態管理完了**

### Phase 4.2: インテリジェント判断 ✅ **2025/9/23完了**
- [x] **自然言語解析** ✅ **LLMによるコンテキスト活用完了**
- [x] **FIFO原則** ✅ **個別在庫法による適切なID取得完了**
- [x] **曖昧性検出** ✅ **ユーザー指定の正確な理解完了**
- [x] **コンテキスト分析** ✅ **在庫状況と操作履歴の活用完了**

### Phase 4.3: 確認プロセス 🔄 **未着手**
- [ ] **操作前検証**システム
- [ ] **確認ダイアログ**機能
- [ ] **エラーハンドリング**の強化

### Phase 4.4: 操作履歴とロールバック 🔄 **未着手**
- [ ] **ロールバック機能**
- [ ] **Undo/Redo機能**
- [ ] **状態復元機能**

### 動的MCPエージェント ✅ **2025/9/22完了**
- [x] **動的ツール選択** ✅ **LLMによる適切なツール選択**
- [x] **動的ツール実行** ✅ **ハードコーディングの完全排除**
- [x] **動的結果整形** ✅ **LLMによる結果の整形**
- [x] **統一されたインターフェース** ✅ **/chatエンドポイントのみ**
- [x] **真の拡張性** ✅ **新しいツールの自動認識**

## Phase 4: 高度なAIエージェント化 🚀 **計画中**

### 設計課題の解決
- [ ] **MCPサーバーの再設計** - CRUDを統合した在庫更新ツール
- [ ] **LLMの思考プロセス強化** - CRUD操作の本質的な判断
- [ ] **高度なパラメータ抽出** - 文脈を理解したパラメータ抽出
- [ ] **レシピ提案機能** - 食材マッチングとレシピ検索

### AI Agent Loop 🚀 **計画中**

#### Perception（認識）
- [ ] 音声入力の認識
- [ ] テキスト意図の解析
- [ ] コンテキスト理解

#### Cognition（思考）
- [ ] 意図の判断
- [ ] 適切なツールの選択
- [ ] 行動計画の立案

#### Action（行動）
- [ ] Supabase CRUD操作
- [ ] レシピ生成・提案
- [ ] Web検索実行
- [ ] レスポンス生成

## Phase 4: 高度な機能 🌟

### 状態管理
- [ ] セッション管理
- [ ] 会話履歴の保持
- [ ] ユーザー設定の管理

### 自動化
- [ ] ツール選択の自動化
- [ ] エラー回復機能
- [ ] 学習機能

### 拡張性
- [ ] プラグインシステム
- [ ] カスタムツール追加
- [ ] 外部API連携

## 技術的ToDo

### MCP実装
- [x] FastMCPでHTTP通信実装 ✅ **2025/9/21完了**
- [x] **FastMCPでstdio通信実装** ✅ **2025/9/22完了**
- [x] **自動起動機能実装** ✅ **2025/9/22完了**
- [ ] mcp.jsonでの設定管理
- [x] エラーハンドリング ✅ **CallToolResult処理完了**
- [ ] ログ管理

### データベース設計
- [x] 在庫管理テーブル設計 ✅ **DDL.mdで完了**
- [ ] レシピマスターデータ設計
- [ ] ユーザー設定テーブル設計
- [ ] インデックス最適化

### セキュリティ
- [x] Row Level Security (RLS) 設定 ✅ **DDL.mdで完了**
- [x] API権限管理 ✅ **JWT認証実装完了**
- [ ] データ暗号化

## 現在の優先度

1. **Supabase CRUD MCP** - ✅ **完全完了！**
2. **stdio接続への移行** - ✅ **完了！**
3. **main.pyへの統合** - ✅ **完了！**
4. **動的MCPエージェント** - ✅ **完了！**
5. **高度なAIエージェント化** - 🚀 **計画中**
6. **レシピ提案機能** - 食材マッチングとレシピ検索

## 完了基準

### Phase 2完了基準 ✅ **達成！**
- Supabase CRUD MCPが正常動作 ✅ **完了**
- stdio接続でMCPサーバー管理 ✅ **完了**
- 基本チャット機能がMCP経由で動作 ✅ **完了**

### Phase 3完了基準 ✅ **達成！**
- 動的MCPエージェントが正常動作 ✅ **完了**
- 動的ツール選択が実装 ✅ **完了**
- 自然言語での在庫管理が可能 ✅ **完了**
- ハードコーディングの完全排除 ✅ **完了**

### Phase 4完了基準
- 高度なAIエージェント化が実装
- 文脈を理解したCRUD操作が可能
- レシピ提案機能が動作
- エラーハンドリングが適切

---

## 🎉 Phase 3完了記念！

**2025年9月22日** - Phase 3: 動的AIエージェント化が完全完了！

### ✅ 達成した成果

#### **完全動的MCPエージェントの実現**
1. **動的ツール選択** - LLMがMCPサーバーから取得したツールリストから適切なツールを選択
2. **動的ツール実行** - ハードコーディングを完全に削除し、任意のツールを動的に実行
3. **動的結果整形** - LLMがすべてのツール結果を適切に整形
4. **統一されたインターフェース** - すべての操作が`/chat`エンドポイント経由で実行

#### **技術的達成**
- ✅ **FastMCP 2.12.3**: 最新版で安定動作
- ✅ **アノテーション方式**: `@mcp.tool()` デコレータ
- ✅ **stdio接続**: プロセス間通信で軽量動作
- ✅ **ReActパターン**: 観察→思考→決定→行動のループ
- ✅ **自然言語処理**: 「牛乳を2本、冷蔵庫に追加して」が正常動作
- ✅ **自動起動**: テスト時の手動起動が不要
- ✅ **完全なCRUD操作**: 5つのツールが全て動作
- ✅ **Supabase認証**: JWT トークン認証が正常動作
- ✅ **セキュリティ**: トークンの安全な取り扱い

#### **推奨実装**
**stdio版（`supabase_mcp_server_stdio.py`）を最優先推奨**
- 軽量、自動起動、ローカル通信、公式準拠

### 🚀 次のフェーズ

**Phase 4: 高度なAIエージェント化** が開始されました！

#### **2025年9月22日の成果**
- ✅ **動的MCPエージェント**: 完全動的なツール選択と実行
- ✅ **ハードコーディング排除**: すべての操作が動的に実行
- ✅ **自然言語在庫管理**: 「牛乳を2本、冷蔵庫に追加して」が正常動作
- ✅ **統一されたインターフェース**: `/chat`エンドポイントのみで全操作

#### **次のステップ**
- 🚀 **高度なAIエージェント化**: 文脈を理解したCRUD操作
- 🚀 **レシピ提案**: 食材マッチングとレシピ検索機能
- 🚀 **設計課題の解決**: MCPサーバーの再設計とLLM思考プロセス強化

---

**最終目標**: 音声駆動型のスマートパントリーAIエージェント
