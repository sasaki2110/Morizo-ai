# Morizo AI - アーキテクチャ設計

## 🚨 緊急課題

### 在庫数量の不一致問題 ✅ **解決完了**
**優先度: 最高** ✅ **2025年9月24日解決**

**問題**: AI報告とDB実際の在庫数量に重大な不一致が発生
- AI報告: 牛乳6本
- DB実際: 牛乳9本（15件の在庫データから6個の牛乳タスクが生成）

**影響**: 
- ユーザーに誤った在庫情報を提供
- 在庫管理の信頼性に致命的な影響
- 削除・更新操作の安全性に問題

**原因分析**:
- LLMの応答が途中で切れる（max_tokens制限）
- JSON解析エラーによるフォールバック処理
- ActionPlannerのプロンプトが長すぎて応答が不完全
- **根本原因**: LLMの単純な足し算が苦手

**実施した対策**:
1. ✅ **ActionPlannerのmax_tokens増加**: 1000→1500に増加
2. ✅ **プロンプト最適化**: 在庫要約の簡潔化とプロンプト全体の簡素化
3. ✅ **LLM集計指示の強化**: 正確な集計ルールと具体例を追加
4. ✅ **フォールバック処理の改善**: 不適切なタスク生成の検出と処理

**解決結果**:
- ✅ **牛乳**: 9本（正確）
- ✅ **鶏もも肉**: 3パック（正確）
- ✅ **もやし**: 3袋（正確）
- ✅ **パン**: 3袋（正確）

**解決日**: 2025年9月24日
**ステータス**: ✅ **完全解決**

## 🚀 シンプルメッセージ処理の最適化 ✅ **2025年9月24日実現**

### LLM判断による責任分離 ✅ **実装完了**

**問題**: 挨拶などのシンプルなメッセージがReActループに流れてしまう
- 「こんにちは」→ 複雑なタスク生成 → エラー
- キーワード判定ロジックの複雑化と保守性の問題

**解決アプローチ**: LLMの自然な判断を活用
- **ActionPlanner**: LLMがJSONで応答しない場合 = シンプルメッセージと判断
- **TrueReactAgent**: 空のタスク配列 → `_generate_simple_response`に流す
- **責任分離**: 複雑なキーワード判定を排除し、LLMの判断に委ねる

**実装結果**:
- ✅ **「こんにちは」**: 直接LLM応答（自然な挨拶）
- ✅ **「今の在庫を教えて」**: 適切にReActループで処理
- ✅ **エレガントなフォールバック**: JSON解析エラーを意図的な判断として処理

### 🎯 将来の最適化可能性

**高速化＋トークン節約の可能性**: 無駄な重複したLLM呼び出しを抑止可能かもしれない

**現状の課題**:
- ActionPlannerでの`create_plan`結果がシンプルメッセージだった場合
- 現在は、TrueReactAgentにて`_generate_simple_response`で再度LLMを呼び出している

**最適化案**:
- ActionPlannerが既にシンプルな応答を生成済みの場合
- その応答をそのまま返すことで、重複LLM呼び出しを回避
- いわゆる「Final Answer判定」の実装が必要

**実装優先度**: 後の高速化・トークン節約の課題として保留

## 🎉 MCPツール拡張による設計思想の進化

### 設計思想の転換 ✅ **2025年9月24日実現**

**従来のアプローチ（失敗）**:
- **1つの引出**: 複雑なReActループで全てを処理
- **問題**: 一括操作要求での複雑なタスク分解
- **結果**: 多数のタスク、エラー発生、ユーザー体験の悪化

**新しいアプローチ（成功）**:
- **複数の引出**: 専用MCPツールで適材適所
- **解決**: 一括操作要求を専用ツールで直接処理
- **結果**: 1つのタスク、エラー解消、ユーザー体験の向上

### MCPツール拡張の実装

#### 新規追加ツール
1. **inventory_delete_by_name**: 名前指定での一括削除
   - 用途: 「牛乳9本全部削除」
   - 効果: 9個の個別タスク → 1つの一括タスク

2. **inventory_update_by_name**: 名前指定での一括更新
   - 用途: 「パンは冷凍したから、賞味期限をクリアしておいて」
   - 効果: 複雑なタスク分解 → 1つの一括タスク

#### 設計原則
- **単一責任**: 各MCPツールは特定の操作に特化
- **拡張性**: 新しい要求パターンにMCPツール追加で対応
- **保守性**: ツールごとの責任が明確
- **ユーザー体験**: 自然な要求がそのまま実行

### 将来の拡張可能性
- **inventory_delete_by_expiry**: 賞味期限切れ商品の一括削除
- **inventory_list_by_location**: 保管場所別の在庫一覧
- **inventory_move_by_name**: 保管場所の一括移動

**設計思想の勝利**: 「引出を増やす」アプローチの成功

## 全体アーキテクチャ

### **現在のアーキテクチャ（リファクタリング完了）**
```
Morizo AI Agent (main.py - 145行)
├── FastAPI Server
├── 統一されたReActエージェントシステム
│   ├── ActionPlanner (行動計画立案)
│   │   ├── 複雑な要求の分析
│   │   ├── タスク分解（単純・複雑問わず）
│   │   ├── 依存関係の特定
│   │   └── 優先度の設定
│   ├── TaskManager (タスク管理)
│   │   ├── タスクの状態管理
│   │   ├── 依存関係の検証
│   │   ├── 実行順序の最適化
│   │   └── 進捗追跡
│   └── TrueReactAgent (統一ReActループ)
│       ├── 観察: 現在の状況把握
│       ├── 思考: 最適な行動の決定
│       ├── 決定: ツール選択とパラメータ設定
│       └── 行動: MCPツールの実行
├── モジュラー設計（15モジュール）
│   ├── config/ (設定管理)
│   │   ├── logging_config.py
│   │   └── cors_config.py
│   ├── auth/ (認証・セキュリティ)
│   │   └── authentication.py
│   ├── agents/ (エージェント・MCP)
│   │   └── mcp_client.py
│   ├── models/ (データモデル)
│   │   └── requests.py
│   ├── utils/ (ユーティリティ)
│   │   ├── session_utils.py
│   │   └── llm_utils.py
│   └── handlers/ (ハンドラー)
│       ├── chat_handler.py
│       └── session_handler.py
├── セッション管理システム
│   ├── SessionContext (メモリ内)
│   ├── 操作履歴管理 (最大10件)
│   ├── 在庫状態管理 (ID情報含む)
│   └── 自動タイムアウト
├── FIFO原則による在庫管理
│   ├── 個別在庫法
│   ├── 最古→最新の操作順序
│   └── ユーザー指定対応
├── MCP Client (stdio接続)
├── Supabase CRUD MCP Server
│   ├── inventory_add
│   ├── inventory_list
│   ├── inventory_get
│   ├── inventory_update
│   └── inventory_delete
└── Supabase PostgreSQL
```

### **目標アーキテクチャ（LangChain統合）**
```
Morizo AI Agent (main.py)
├── FastAPI Server
├── LangChain ReAct Agent
│   ├── Tool Selection
│   ├── MCP Tools (LangChain化)
│   └── Recipe Tools
├── MCP Server (stdio接続)
└── Supabase PostgreSQL
```

## AI Agent基本ループ

### **統一されたReActエージェントループ（実装完了）**
```
すべての要求の処理（単純・複雑問わず）:
1. 要求分析 → ActionPlanner
2. タスク分解 → 個別タスクの生成（1個または複数）
3. 依存関係特定 → 実行順序の決定
4. ReActループ実行:
   - 観察: 現在の状況把握
   - 思考: 最適な行動の決定
   - 決定: ツール選択とパラメータ設定
   - 行動: MCPツールの実行
5. 完了報告 → ユーザーへの結果通知
```

### **リファクタリング前の混在ループ（削除済み）**
```
❌ 削除された混在システム:
- なんちゃってReAct（単一サイクル）
- 真のReAct（複数サイクル）
- 判定ロジックによる分岐
→ 統一されたReActエージェントに統合
```

### Action（行動）
- Supabase CRUD操作
- レシピ生成・提案
- Web検索実行
- レスポンス生成

## MCP設計思想

### stdio通信による軽量実装
- HTTPサーバー不要
- ローカル通信のみ
- 設定が簡単

### モジュラー設計
- 各機能を独立したMCPサーバーとして分離
- 必要な分だけMCPサーバーを追加
- 個別にテスト可能

### スケーラブルな拡張性
- 新しいツールの追加が容易
- プラグインシステム
- カスタムツール対応

## 技術スタック

### バックエンド
- **FastAPI**: メインAPIサーバー
- **OpenAI API**: LLM・音声認識
- **Supabase**: 認証・データベース
- **FastMCP**: MCPサーバー実装

### フロントエンド
- **Next.js**: Webアプリケーション
- **Supabase Auth**: 認証管理
- **Web Speech API**: 音声入力

## データフロー

1. **音声入力** → Web Speech API → テキスト変換
2. **テキスト解析** → Perception MCP → 意図理解
3. **思考・判断** → Cognition MCP → ツール選択
4. **行動実行** → Action MCP → Supabase CRUD
5. **レスポンス生成** → LLM → 自然な応答

## セキュリティ設計

### 認証・認可
- Supabase認証システム
- Bearer Token認証
- Row Level Security (RLS)

### データ保護
- ユーザー別データ分離
- API権限管理
- データ暗号化

## 拡張性

### Phase 1: 基本機能
- 単純なチャット機能
- 基本的なCRUD操作

### Phase 2: MCP化 ✅ **完了**
- モジュラー設計
- ツール分離
- stdio接続
- main.py統合

### Phase 3: 動的AIエージェント化 ✅ **完了**
- ReAct Agent
- 動的ツール選択
- 自然言語理解
- 完全動的MCPエージェント

### Phase 4.1: 基本コンテキスト管理 ✅ **完了**
- セッション管理
- 操作履歴
- 在庫状態管理

### Phase 4.2: インテリジェント判断 ✅ **完了**
- FIFO原則
- 個別在庫法
- ユーザー指定対応

### Phase 4.3: 真のAIエージェント化 ✅ **完了**
- ActionPlanner
- TaskManager
- TrueReactAgent

### Phase 4.4: 確認プロセス 🚀 **計画中**
- 操作前検証
- 確認ダイアログ
- エラーハンドリング強化

### Phase 4.5: ロールバック機能 🚀 **計画中**
- 操作履歴
- ロールバック
- Undo/Redo機能

### Phase 5: リファクタリング ✅ **完了**
- 71%のコード削減
- 完全な責任分離
- 統一されたReActエージェント
- 15モジュールに分割
