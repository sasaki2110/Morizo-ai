# Morizo AI - 最優先課題

## 📋 概要

**作成日**: 2025年9月29日  
**最終更新**: 2025年9月29日  
**バージョン**: 2.0  
**作成者**: AIエージェント協働チーム

## 🎯 最優先課題（即座に対応）

### 1. 食材重複回避機能 🔥 **最優先**

#### 問題
- 同じ食材を使った主菜・副菜が提案されている
- 例: 豚バラブロックが主菜と副菜の両方で使用される
- 乏しい在庫の効率的活用ができていない

#### 影響
- ユーザーの要求「材料の重複しない主菜・副菜・汁物の提案」に未対応
- 限られた食材の無駄遣い
- 提案の多様性が低下

#### 対応策
**AIネイティブな食材重複回避アプローチ**

1. **候補生成 + AI制約解決方式**
   - LLM/RAG検索で複数の献立候補を生成
   - 各候補に食材情報（ingredients）を含める
   - AI制約解決エンジンで重複なしの最適組み合わせを選択

2. **実装方式**
   - **LLM生成**: 複数候補生成時に食材情報も同時出力
   - **RAG検索**: 既存の食材情報を活用して候補を取得
   - **制約解決**: 単一のLLM呼び出しで重複回避を実現

3. **技術的利点**
   - 再帰呼び出し不要（パフォーマンス向上）
   - 制約解決の透明性（選択理由が明確）
   - LLM/RAG両方に適用可能（一貫性）
   - 従来の総当たりアルゴリズムを回避（AIネイティブ）

#### 完了基準
- [x] LLM生成時の複数候補 + 食材情報出力機能
- [x] RAG検索結果の食材情報活用機能
- [x] AI制約解決エンジンの実装
- [x] 重複回避の自動選択機能
- [x] LLM/RAG両方式での重複回避テスト

---

### 2. レシピ保存機能 🔥 **最優先**

#### 問題
- 作ったレシピを保存する機能が未実装
- 2週間の重複回避ができない
- ユーザーの調理履歴が蓄積されない

#### 影響
- ユーザーの要求「2週間程度は同じレシピを提案しない」に未対応
- パーソナライズされた提案ができない
- 調理履歴の活用ができない

#### 対応策
- `true_react_agent.py`にレシピ保存機能を実装
- ユーザーがレシピを選択した時に自動保存
- 既存のDB MCP（`recipes_add`）を活用

#### 完了基準
- [ ] レシピ選択時の自動保存機能
- [ ] 作ったレシピの履歴管理
- [ ] 保存されたレシピの確認機能
- [ ] テストでの保存機能確認

---

### 3. レシピ履歴参照機能 🔥 **最優先**

#### 問題
- 提案時に過去のレシピ履歴を参照していない
- 2週間以内のレシピが除外されていない
- 重複したレシピが提案される

#### 影響
- 同じレシピの繰り返し提案
- ユーザー体験の低下
- パーソナライゼーションの欠如

#### 対応策
- `true_react_agent.py`に過去履歴取得機能を実装
- 提案時に過去14日間のレシピを除外
- 既存のDB MCP（`recipes_list`）を活用

#### 完了基準
- [ ] 過去14日間のレシピ履歴取得機能
- [ ] 提案時の履歴除外機能
- [ ] 除外レシピリストの生成
- [ ] テストでの履歴参照確認

---

## 🚀 高優先課題（1-2週間以内）

### 4. パフォーマンス改善（ストリーミング機能）

#### 問題
- 1分間の待機時間でユーザー体験が最悪
- 処理状況がユーザーに伝わらない
- 重たい処理の進行状況が不明

#### 対応策
- Server-Sent Events (SSE) によるリアルタイム進捗表示
- タスク実行状況の可視化
- 進捗バーとエラー通知機能

#### 完了基準
- [ ] SSEエンドポイントの実装
- [ ] 進捗表示機能の実装
- [ ] エラー通知機能の実装
- [ ] フロントエンド側の実装

---

### 5. フロントエンド対応

#### 問題
- レシピ選択UIが未実装
- 献立提案の視覚的表示が不十分
- ユーザーが選択しやすいUIがない

#### 対応策
- レシピ選択のプルダウンUI実装
- レシピビューアーの実装
- 献立提案の視覚的表示

#### 完了基準
- [ ] レシピ選択プルダウンUI
- [ ] レシピビューアー機能
- [ ] 献立提案の視覚的表示
- [ ] レスポンシブデザイン対応

---

## 🔧 中優先課題（1ヶ月以内）

### 6. ユーザー分析機能

#### 問題
- どの提案が選ばれやすいかの統計がない
- データドリブンな改善ができない
- ユーザー行動の分析ができない

#### 対応策
- 提案選択率の追跡機能
- ユーザー行動分析機能
- A/Bテスト機能

#### 完了基準
- [ ] 提案選択率の追跡
- [ ] ユーザー行動分析
- [ ] A/Bテスト機能
- [ ] 統計ダッシュボード

---

### 7. Google Search API統合

#### 問題
- PerplexityでCookpad等の制限されたサイトにアクセスできない
- レシピ検索の精度が限定的
- より多様なレシピソースが必要

#### 対応策
- Google Search API統合
- Perplexity + Google Searchの並列検索
- レシピ品質評価システム

#### 完了基準
- [ ] Google Search API統合
- [ ] 並列検索機能
- [ ] レシピ品質評価
- [ ] 検索結果の最適化

---

## 📊 進捗管理

### 完了済み
- [x] Phase 4.5 並列提示システム（2025年9月29日完了）
- [x] MCPツール修正（2025年9月29日完了）
- [x] レシピ検索統合（2025年9月29日完了）
- [x] ログ出力削減（2025年9月29日完了）
- [x] 音声認識機能（Web版・モバイル版実装済み）
- [x] 食材重複回避機能（2025年9月30日完了）

### 進行中
- [ ] レシピ保存機能
- [ ] レシピ履歴参照機能

### 未着手
- [ ] パフォーマンス改善（ストリーミング機能）
- [ ] フロントエンド対応
- [ ] ユーザー分析機能
- [ ] Google Search API統合

---

## 🎯 成功基準

### 最優先課題完了基準
- [x] 食材重複の完全回避
- [ ] レシピ保存機能の完全動作
- [ ] 2週間の重複回避機能の実現

### 高優先課題完了基準
- [ ] ストリーミング機能によるリアルタイム進捗表示
- [ ] フロントエンドUIの完全実装

### 中優先課題完了基準
- [ ] ユーザー分析機能の実装
- [ ] Google Search API統合の完了

---

## 🚀 期待される効果

### 最優先課題完了時
- **ユーザー要求の完全対応**: 食材重複回避 + 2週間重複回避
- **パーソナライゼーション**: 調理履歴に基づく提案
- **食材効率の向上**: 限られた食材の最大活用

### 全課題完了時
- **完全なユーザー体験**: ストリーミング + UI + パーソナライゼーション
- **データドリブンな改善**: ユーザー行動分析による継続的改善
- **多様なレシピソース**: Google Search統合による豊富なレシピ

---

## 🏗️ 責任分離の設計思想

### レシピ提案フローの責任分離

**設計思想**: LLMレシピタイトル推論、RAGレシピタイトル検索、タイトルから具体的なレシピをWEB検索する流れの責任の分離

#### タスク定義

**task1 在庫リスト取得**
- **入力**: 無し
- **出力**: 在庫リスト
- **依存**: なし
- **責任**: 在庫一覧の取得
- **実装**: `inventory_list`

**task2 LLM推論**
- **入力**: task1の出力（在庫リスト）
- **出力**: 献立（主菜・副菜・汁物）のタイトル
- **依存**: task1に依存
- **責任**: タイトル推論
- **実装**: `generate_menu_plan_with_history`

**task3 RAG検索**
- **入力**: task1の出力（在庫リスト）
- **出力**: 献立（主菜・副菜・汁物）のタイトル
- **依存**: task1に依存
- **責任**: タイトル検索
- **実装**: `search_menu_from_rag_with_history`

**task4 WEB検索**
- **入力**: task2、task3の出力（タイトル）
- **出力**: 各タイトルの具体的レシピURL
- **依存**: task2、task3に依存
- **責任**: レシピURL取得
- **実装**: `search_recipe_from_web`

#### 設計原則

1. **単一責任原則**: 各タスクは明確な単一の責任を持つ
2. **依存関係の明確化**: タスク間の依存関係を明確に定義
3. **循環参照の回避**: MCPツールからMCPツールへの直接呼び出しを禁止
4. **データフローの透明性**: 入力・出力・依存関係を明確に文書化

---

## 📝 メモ・注意事項

- 最優先課題は即座に対応が必要
- 高優先課題は1-2週間以内に対応
- 中優先課題は1ヶ月以内に対応
- 各課題の完了基準を明確に設定
- 進捗管理を定期的に更新
- 既存のDB MCP機能を最大限活用
- **責任分離の設計思想を厳守**: 循環参照を避け、各タスクの責任を明確に分離

---

**最終更新**: 2025年9月30日  
**バージョン**: 2.2  
**作成者**: AIエージェント協働チーム

## 📝 更新履歴

### v2.2 (2025年9月30日) - 食材重複回避機能の完全実装完了
- ✅ **食材重複回避機能の完全実装**: AIネイティブな制約解決により重複回避が正常動作
- ✅ **ハードコーディング処理の削除**: `_fix_ingredient_duplication`、`_apply_ingredient_constraints`を削除
- ✅ **AIネイティブ設計思想の徹底**: 手動処理を排除し、LLM/RAG制約解決エンジンに統一
- ✅ **ログ出力の最適化**: 詳細ログをDEBUGに変更し、主要ログのみINFOで出力
- ✅ **RAG検索結果の活用強化**: LLMプロンプトを改善し、RAG検索結果を確実に使用
- ✅ **Web検索クエリの改善**: 「作り方」サフィックスを削除し、動的注入問題を解決

#### 実装完了詳細
**LLM推論（斬新献立）側**: ✅ **完全にAIネイティブ**
- 複数候補生成 → AI制約解決 → 最適選択の流れ
- `generate_menu_with_llm_constraints`関数で実装
- 重複回避が正常動作、レシピURLも表示

**RAG検索（従来献立）側**: ✅ **完全にAIネイティブ**
- `generate_menu_with_rag_constraints`関数で実装
- 複数候補生成 → AI制約解決 → 最適選択の流れ
- ハードコーディングされた手動選択を完全削除

#### 技術的改善
1. **制約解決エンジンの統一**: LLM/RAG両方式で一貫したAIネイティブアプローチ
2. **プロンプトエンジニアリング**: RAG検索結果の確実な活用を保証
3. **ログレベル最適化**: 本番環境での運用性向上
4. **設計思想の徹底**: ハードコーディング処理の完全排除

### v2.1 (2025年9月30日) - 食材重複回避機能の実装状況と課題
- ✅ **レシピURL表示問題の修正**: LLM推論結果のタイトルがWEB検索に正しく渡されるよう修正
- ✅ **ログクリア問題の修正**: 統合テスト実行時のログ消失問題を解決
- ✅ **LLM推論側の重複回避**: AIネイティブな制約解決により重複回避が正常動作
- ⚠️ **RAG検索側の重複回避**: 手動選択による古臭い実装で、AIネイティブではない
- 🔍 **課題の特定**: RAG検索の制約解決エンジンが除外食材を正しく処理できていない

### v2.0 (2025年9月29日)
- ✅ **PRIORITY_TASK.md完全再構築**: バックエンド改善を中心とした新しい優先課題リスト
- ✅ **食材重複回避**: 最優先課題として追加
- ✅ **レシピ保存機能**: 最優先課題として追加
- ✅ **レシピ履歴参照**: 最優先課題として追加
- ✅ **パフォーマンス改善**: ストリーミング機能として高優先課題に追加
- ✅ **フロントエンド対応**: 高優先課題として追加

### v1.3 (2025年9月29日)
- ✅ **MCPツール切り分け修正**: `search_menu_from_rag_with_history`の正しいサーバー割り当て
- ✅ **Token validation修正**: パラメータエラーの完全解決
- ✅ **並列実行の最適化**: 依存関係エラーの改善完了
- ✅ **完全動作確認**: 3/3テスト成功 (100%)